<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DigiClick - Admin Panel</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- Added Chart.js for graphs -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                    colors: {
                        'brand-primary': '#111827', // Darker Gray
                        'brand-secondary': '#f9fafb', // Lighter Gray
                        'brand-accent': '#3b82f6', // A nice Blue
                        'brand-accent-hover': '#2563eb',
                        'sidebar-bg': '#1f2937',
                        'sidebar-text': '#d1d5db',
                        'sidebar-active': '#3b82f6',
                    }
                }
            }
        }
    </script>
    <style>
        body { font-family: 'Inter', sans-serif; }
        .modal-overlay { transition: opacity 0.3s ease-in-out; }
        
        .sidebar-nav-link {
            display: flex;
            align-items: center;
            padding: 0.75rem 1.5rem;
            color: #d1d5db;
            font-weight: 500;
            border-radius: 0.375rem;
            transition: background-color 0.2s ease-in-out, color 0.2s ease-in-out;
        }
        .sidebar-nav-link:hover {
            background-color: #374151;
            color: #ffffff;
        }
        .sidebar-nav-link.active {
            background-color: #3b82f6;
            color: #ffffff;
            font-weight: 600;
        }

        /* Responsive Table Styles */
        @media (max-width: 768px) {
            .responsive-table thead { display: none; }
            .responsive-table tr {
                display: block;
                margin-bottom: 1.5rem;
                border: 1px solid #e5e7eb;
                border-radius: 0.5rem;
                box-shadow: 0 1px 3px rgba(0,0,0,0.05);
                padding: 1rem;
            }
            .responsive-table td {
                display: flex;
                justify-content: space-between;
                align-items: center;
                padding: 0.75rem 0;
                border-bottom: 1px solid #f3f4f6;
            }
            .responsive-table td:last-child { border-bottom: none; }
            .responsive-table td::before {
                content: attr(data-label);
                font-weight: 600;
                margin-right: 1rem;
            }
        }
    </style>
</head>
<body class="bg-brand-secondary">

    <!-- Login View -->
    <div id="login-view" class="flex items-center justify-center min-h-screen p-4 bg-gray-100">
        <div class="w-full max-w-sm bg-white p-8 rounded-2xl shadow-lg transform transition-all hover:scale-105">
            <h1 class="text-3xl font-bold text-center text-brand-primary mb-2">Admin Panel</h1>
            <p class="text-center text-gray-500 mb-8">Please sign in to continue</p>
            <form id="login-form">
                <div class="mb-4">
                    <label for="admin-email" class="block text-sm font-medium text-gray-700 mb-1">Email</label>
                    <input type="email" id="admin-email" name="email" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-brand-accent" required>
                </div>
                <div class="mb-6">
                    <label for="admin-password" class="block text-sm font-medium text-gray-700 mb-1">Password</label>
                    <input type="password" id="admin-password" name="password" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-brand-accent" required>
                </div>
                <p id="login-feedback" class="mb-4 text-sm text-center text-red-600"></p>
                <button type="submit" class="w-full bg-brand-primary text-white font-bold py-3 rounded-lg hover:bg-gray-700 transition-colors duration-300 shadow-md hover:shadow-lg">Sign In</button>
            </form>
        </div>
    </div>

    <!-- Main Admin Dashboard (hidden by default) -->
    <div id="admin-dashboard" class="hidden">
        <div class="flex h-screen bg-gray-100">
            <!-- Sidebar -->
            <aside id="sidebar" class="w-64 bg-sidebar-bg text-sidebar-text flex-shrink-0 p-4 fixed lg:relative h-full z-40 transform -translate-x-full lg:translate-x-0 transition-transform duration-300 ease-in-out">
                <div class="flex items-center justify-between mb-8">
                    <h1 class="text-2xl font-bold text-white">DigiClick</h1>
                    <button id="close-sidebar-btn" class="lg:hidden text-gray-400 hover:text-white">
                        <i data-lucide="x" class="w-6 h-6"></i>
                    </button>
                </div>
                <nav id="sidebar-nav" class="space-y-2">
                    <a href="#" class="sidebar-nav-link active" data-tab="dashboard"><i data-lucide="home" class="w-5 h-5 mr-3"></i>Dashboard</a>
                    <a href="#" class="sidebar-nav-link" data-tab="products"><i data-lucide="package" class="w-5 h-5 mr-3"></i>Products</a>
                    <a href="#" class="sidebar-nav-link" data-tab="categories"><i data-lucide="layout-grid" class="w-5 h-5 mr-3"></i>Categories</a>
                    <a href="#" class="sidebar-nav-link" data-tab="testimonials"><i data-lucide="star" class="w-5 h-5 mr-3"></i>Testimonials</a>
                    <a href="#" class="sidebar-nav-link" data-tab="site-content"><i data-lucide="file-text" class="w-5 h-5 mr-3"></i>Site Content</a>
                    <a href="#" id="users-tab-btn" class="sidebar-nav-link hidden" data-tab="users"><i data-lucide="users" class="w-5 h-5 mr-3"></i>Users</a>
                </nav>
            </aside>
            
            <div id="sidebar-overlay" class="fixed inset-0 bg-black bg-opacity-50 z-30 hidden lg:hidden"></div>

            <!-- Main Content -->
            <div class="flex-1 flex flex-col overflow-hidden">
                <header class="bg-white shadow-sm">
                    <div class="container mx-auto px-4 sm:px-6 py-4 flex justify-between items-center">
                        <button id="open-sidebar-btn" class="lg:hidden text-gray-600 hover:text-brand-primary">
                            <i data-lucide="menu" class="w-6 h-6"></i>
                        </button>
                        <div class="flex-1 text-right">
                           <div class="flex items-center justify-end gap-4">
                                <div class="text-right">
                                    <p id="user-email-display" class="font-semibold text-gray-800"></p>
                                    <p id="user-role-display" class="text-sm text-gray-500"></p>
                                </div>
                                <button id="logout-btn" class="bg-red-500 text-white font-bold p-2 rounded-full hover:bg-red-600 transition-colors duration-300 flex items-center justify-center">
                                    <i data-lucide="log-out" class="w-5 h-5"></i>
                                </button>
                           </div>
                        </div>
                    </div>
                </header>

                <main class="flex-1 overflow-x-hidden overflow-y-auto bg-brand-secondary">
                    <div class="container mx-auto px-4 sm:px-6 py-8">
                        <!-- Tab Content -->
                        <div id="tab-content">
                            <!-- Populated by JS -->
                        </div>
                    </div>
                </main>
            </div>
        </div>
    </div>

    <!-- Modals (Populated by JS) -->
    <div id="product-modal" class="modal-overlay fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4 opacity-0 pointer-events-none"></div>
    <div id="category-modal" class="modal-overlay fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4 opacity-0 pointer-events-none"></div>
    <div id="testimonial-modal" class="modal-overlay fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4 opacity-0 pointer-events-none"></div>
    <div id="user-modal" class="modal-overlay fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4 opacity-0 pointer-events-none"></div>
    <div id="confirmation-modal" class="modal-overlay fixed inset-0 bg-black bg-opacity-60 z-50 flex items-center justify-center p-4 opacity-0 pointer-events-none"></div>

    <script type="module">
        // --- Firebase Integration ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js";
        import { getFirestore, collection, onSnapshot, addDoc, doc, updateDoc, deleteDoc, serverTimestamp, getDoc, setDoc, query, orderBy, limit } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBgErP_g_ZqKraxqFAQi3W0YdwwkQdAZzg",
            authDomain: "my-chat-app-a9b9e.firebaseapp.com",
            projectId: "my-chat-app-a9b9e",
            storageBucket: "my-chat-app-a9b9e.appspot.com",
            messagingSenderId: "292137527608",
            appId: "1:292137527608:web:692b165effa77e79bf79cd"
        };

        // --- App Initialization ---
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        
        // --- Firestore Collections ---
        const productsCollection = collection(db, 'products');
        const categoriesCollection = collection(db, 'categories');
        const testimonialsCollection = collection(db, 'testimonials');
        const usersCollection = collection(db, 'adminUsers');
        const siteContentDocRef = doc(db, 'siteContent', 'homepage');

        // --- State ---
        let products = [], categories = [], testimonials = [], users = [];
        let unsubscribers = [];
        let deleteAction = null;
        let currentUserRole = null;
        let categoryChart = null;

        // --- DOM Elements ---
        const loginView = document.getElementById('login-view');
        const adminDashboard = document.getElementById('admin-dashboard');
        const sidebar = document.getElementById('sidebar');
        const sidebarOverlay = document.getElementById('sidebar-overlay');
        const tabContentContainer = document.getElementById('tab-content');

        // --- All Function Definitions ---

        // Rendering Functions
        function renderActiveTabData() {
            const activeLink = document.querySelector('.sidebar-nav-link.active');
            if (!activeLink) return;
            
            const activeTabId = activeLink.dataset.tab;
            switch(activeTabId) {
                case 'dashboard':
                    renderCategoryChart(products, categories);
                    break;
                case 'products':
                    renderProductsTable(products);
                    break;
                case 'categories':
                    renderCategoriesTable(categories);
                    break;
                case 'testimonials':
                    renderTestimonialsTable(testimonials);
                    break;
                case 'users':
                    renderUsersTable(users);
                    break;
            }
        }

        function renderCategoryChart(productsData, categoriesData) {
            const ctx = document.getElementById('categoryChart');
            if (!ctx) return;

            const categoryCounts = categoriesData.reduce((acc, category) => {
                acc[category.name] = 0;
                return acc;
            }, {});

            productsData.forEach(product => {
                if (product.category && categoryCounts.hasOwnProperty(product.category)) {
                    categoryCounts[product.category]++;
                }
            });

            const labels = Object.keys(categoryCounts);
            const data = Object.values(categoryCounts);

            if (categoryChart) {
                categoryChart.destroy();
            }

            categoryChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Products per Category',
                        data: data,
                        backgroundColor: [
                            '#3b82f6', '#ef4444', '#22c55e', '#f97316',
                            '#8b5cf6', '#ec4899', '#f59e0b', '#10b981'
                        ],
                        hoverOffset: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'top',
                        },
                        title: {
                            display: true,
                            text: 'Product Distribution by Category'
                        }
                    }
                }
            });
        }

        function renderProductsTable(data) {
            const body = document.getElementById('products-table-body');
            if (!body) return;
            body.innerHTML = data.length ? data.map(p => `
                <tr class="hover:bg-gray-50">
                    <td data-label="Name" class="p-4 font-medium text-gray-800">${p.name || ''}</td>
                    <td data-label="Category" class="p-4 text-gray-600">${p.category || ''}</td>
                    <td data-label="Variants" class="p-4 text-gray-600">${p.variants ? p.variants.length : 0}</td>
                    <td data-label="Actions" class="p-4 space-x-2 sm:space-x-4">
                        <button class="edit-btn font-semibold text-blue-600 hover:text-blue-800" data-type="product" data-id="${p.id}">Edit</button>
                        <button class="delete-btn font-semibold text-red-600 hover:text-red-800" data-type="product" data-id="${p.id}">Delete</button>
                    </td>
                </tr>`).join('') : '<tr><td colspan="4" class="text-center p-8 text-gray-500">No products found.</td></tr>';
        }

        function renderCategoriesTable(data) {
            const body = document.getElementById('categories-table-body');
            if (!body) return;
            body.innerHTML = data.length ? data.map(c => `
                <tr class="hover:bg-gray-50">
                    <td data-label="Name" class="p-4 font-medium text-gray-800">${c.name || ''}</td>
                    <td data-label="Image" class="p-4"><img src="${c.image || 'https://placehold.co/80x48/e2e8f0/64748b?text=No+Image'}" onerror="this.onerror=null;this.src='https://placehold.co/80x48/e2e8f0/64748b?text=No+Image';" alt="${c.name || ''}" class="w-20 h-12 object-cover rounded-md bg-gray-100"/></td>
                    <td data-label="Actions" class="p-4 space-x-2 sm:space-x-4">
                        <button class="edit-btn font-semibold text-blue-600 hover:text-blue-800" data-type="category" data-id="${c.id}">Edit</button>
                        <button class="delete-btn font-semibold text-red-600 hover:text-red-800" data-type="category" data-id="${c.id}">Delete</button>
                    </td>
                </tr>`).join('') : '<tr><td colspan="3" class="text-center p-8 text-gray-500">No categories found.</td></tr>';
        }

        function renderTestimonialsTable(data) {
            const body = document.getElementById('testimonials-table-body');
            if (!body) return;
            body.innerHTML = data.length ? data.map(t => `
                <tr class="hover:bg-gray-50">
                    <td data-label="Name" class="p-4 font-medium text-gray-800">${t.name || ''}</td>
                    <td data-label="Location" class="p-4 text-gray-600">${t.location || ''}</td>
                    <td data-label="Text" class="p-4 text-gray-600 truncate max-w-xs">${t.text || ''}</td>
                    <td data-label="Actions" class="p-4 space-x-2 sm:space-x-4">
                        <button class="edit-btn font-semibold text-blue-600 hover:text-blue-800" data-type="testimonial" data-id="${t.id}">Edit</button>
                        <button class="delete-btn font-semibold text-red-600 hover:text-red-800" data-type="testimonial" data-id="${t.id}">Delete</button>
                    </td>
                </tr>`).join('') : '<tr><td colspan="4" class="text-center p-8 text-gray-500">No testimonials found.</td></tr>';
        }

        function renderUsersTable(data) {
            const body = document.getElementById('users-table-body');
            if (!body) return;
            body.innerHTML = data.length ? data.map(u => `
                <tr class="hover:bg-gray-50">
                    <td data-label="Email" class="p-4 font-medium text-gray-800">${u.email || ''}</td>
                    <td data-label="Role" class="p-4 text-gray-600">${u.role || ''}</td>
                    <td data-label="Actions" class="p-4 space-x-2 sm:space-x-4">
                        <button class="edit-btn font-semibold text-blue-600 hover:text-blue-800" data-type="user" data-id="${u.id}">Edit Role</button>
                        ${auth.currentUser.uid !== u.id ? `<button class="delete-btn font-semibold text-red-600 hover:text-red-800" data-type="user" data-id="${u.id}">Delete</button>` : ''}
                    </td>
                </tr>`).join('') : '<tr><td colspan="3" class="text-center p-8 text-gray-500">No users found.</td></tr>';
        }

        // Data & Form Handling
        async function loadSiteContent() {
            const form = document.getElementById('site-content-form');
            if (!form) return;
            try {
                const docSnap = await getDoc(siteContentDocRef);
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    form.querySelector('[name="heroTitle"]').value = data.heroTitle || '';
                    form.querySelector('[name="heroSubtitle"]').value = data.heroSubtitle || '';
                    form.querySelector('[name="heroBackgroundImage"]').value = data.heroBackgroundImage || '';
                    form.querySelector('[name="promotionText"]').value = data.promotionText || '';
                }
            } catch (error) {
                console.error("Error loading site content:", error);
            }
        }

        async function handleFormSubmit(e, type, collection) {
            e.preventDefault();
            const form = e.target;
            const id = form.querySelector('input[type="hidden"]').value;
            const formData = new FormData(form);
            const data = Object.fromEntries(formData.entries());
            delete data.id;

            if (type === 'Product') {
                const variantNodes = document.getElementById('variants-container').querySelectorAll('.variant-item');
                data.variants = Array.from(variantNodes).map(node => ({
                    name: node.querySelector('.variant-name').value,
                    price: parseFloat(node.querySelector('.variant-price').value) || 0,
                    paymentLink: node.querySelector('.variant-link').value
                }));
            }

            if (type === 'User') {
                if (id) {
                    try {
                        await updateDoc(doc(db, collection.path, id), { role: data.role });
                        closeModal('user-modal');
                    } catch (error) { console.error("Error updating role:", error); }
                } else {
                    // User creation via email/password in client is complex and less secure.
                    // This should ideally be handled by a backend function.
                    alert("User creation from the admin panel requires a secure backend (e.g., Firebase Functions) and is disabled in this demo.");
                }
                return;
            }

            try {
                if (id) {
                    await updateDoc(doc(db, collection.path, id), { ...data, updatedAt: serverTimestamp() });
                } else {
                    await addDoc(collection, { ...data, createdAt: serverTimestamp() });
                }
                closeModal(`${type.toLowerCase()}-modal`);
            } catch (error) {
                console.error(`Error saving ${type}:`, error);
                alert(`Error saving ${type}. Check console for details.`);
            }
        }

        async function handleSiteContentFormSubmit(e) {
            e.preventDefault();
            const form = e.target;
            const formData = new FormData(form);
            const data = Object.fromEntries(formData.entries());
            data.updatedAt = serverTimestamp();
            try {
                await setDoc(siteContentDocRef, data, { merge: true });
                alert('Site content updated!');
            } catch (error) {
                console.error("Error saving site content:", error);
                alert("Error saving site content.");
            }
        }

        // UI Interaction Functions
        function switchTab(tabId) {
            document.querySelectorAll('.sidebar-nav-link').forEach(link => {
                link.classList.toggle('active', link.dataset.tab === tabId);
            });
            populateTabContent(tabId);
            if (window.innerWidth < 1024) {
                sidebar.classList.add('-translate-x-full');
                sidebarOverlay.classList.add('hidden');
            }
        }

        function openModal(modalId, item, type) {
            const modal = document.getElementById(modalId);
            if (!modal) return;
            const form = modal.querySelector('form');
            form.reset();
            form.querySelector('input[type="hidden"]').value = '';

            if (item) {
                modal.querySelector('h2').textContent = `Edit ${type}`;
                form.querySelector('input[type="hidden"]').value = item.id;
                Object.keys(item).forEach(key => {
                    const input = form.querySelector(`[name="${key}"]`);
                    if (input && item[key] !== undefined) {
                         input.value = item[key];
                    }
                });
                if (type === 'Product' && item.variants) {
                    document.getElementById('variants-container').innerHTML = '';
                    item.variants.forEach(v => addVariantInput(v));
                }
                if (type === 'User') {
                    form.querySelector('[name="email"]').disabled = true;
                    form.querySelector('[name="password"]').parentElement.classList.add('hidden');
                }
            } else {
                modal.querySelector('h2').textContent = `Add New ${type}`;
                if (type === 'Product') {
                    document.getElementById('variants-container').innerHTML = '';
                    addVariantInput();
                }
                 if (type === 'User') {
                    form.querySelector('[name="email"]').disabled = false;
                    form.querySelector('[name="password"]').parentElement.classList.remove('hidden');
                }
            }

            if (type === 'Product') {
                const categorySelect = document.getElementById('product-category');
                categorySelect.innerHTML = categories.map(c => `<option value="${c.name}">${c.name}</option>`).join('');
                if (item && item.category) {
                    categorySelect.value = item.category;
                }
            }

            modal.classList.remove('opacity-0', 'pointer-events-none');
            lucide.createIcons();
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.add('opacity-0', 'pointer-events-none');
        }

        function showConfirmationModal(id, type, collection) {
            if (type === 'user' && (currentUserRole !== 'Admin' || auth.currentUser.uid === id)) {
                alert("You don't have permission for this action.");
                return;
            }
            const modal = document.getElementById('confirmation-modal');
            modal.classList.remove('opacity-0', 'pointer-events-none');
            deleteAction = async () => {
                try {
                    await deleteDoc(doc(db, collection.path, id));
                } catch (error) {
                    console.error(`Error deleting ${type}:`, error);
                    alert(`Error deleting ${type}.`);
                } finally {
                    closeConfirmationModal();
                }
            };
        }

        function closeConfirmationModal() {
            document.getElementById('confirmation-modal').classList.add('opacity-0', 'pointer-events-none');
            deleteAction = null;
        }

        function addVariantInput(variant = { name: '', price: '', paymentLink: '' }) {
            const div = document.createElement('div');
            div.className = 'variant-item p-3 border rounded-md relative bg-gray-50';
            div.innerHTML = `
                <div class="grid grid-cols-1 sm:grid-cols-3 gap-3">
                    <input type="text" placeholder="Variant Name" class="variant-name w-full px-2 py-1 border rounded-md" value="${variant.name || ''}" required>
                    <input type="number" placeholder="Price" class="variant-price w-full px-2 py-1 border rounded-md" value="${variant.price || ''}" required>
                    <input type="url" placeholder="Payment Link" class="variant-link w-full px-2 py-1 border rounded-md" value="${variant.paymentLink || ''}" required>
                </div>
                <button type="button" class="remove-variant-btn absolute -top-2 -right-2 bg-red-500 text-white rounded-full w-6 h-6 flex items-center justify-center text-lg font-bold hover:bg-red-600 transition-colors">&times;</button>
            `;
            document.getElementById('variants-container').appendChild(div);
        }

        function handleLogin(e) {
            e.preventDefault();
            const email = document.getElementById('admin-email').value;
            const password = document.getElementById('admin-password').value;
            const feedback = document.getElementById('login-feedback');
            signInWithEmailAndPassword(auth, email, password)
                .catch((error) => {
                    feedback.textContent = 'Invalid email or password.';
                    console.error("Login Error:", error);
                });
        }

        function handleLogout() {
            signOut(auth);
        }
        
        function startDashboardSession() {
            if (unsubscribers.length > 0) { // Clear old listeners on re-login
                unsubscribers.forEach(unsub => unsub());
                unsubscribers = [];
            }
            
            updateUIAccess();
            switchTab('dashboard'); 
            
            unsubscribers.push(onSnapshot(productsCollection, (snapshot) => { products = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })); renderActiveTabData(); }));
            unsubscribers.push(onSnapshot(categoriesCollection, (snapshot) => { categories = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })); renderActiveTabData(); }));
            unsubscribers.push(onSnapshot(testimonialsCollection, (snapshot) => { testimonials = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })); renderActiveTabData(); }));
            
            if (currentUserRole === 'Admin') {
                unsubscribers.push(onSnapshot(usersCollection, (snapshot) => { users = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })); renderActiveTabData(); }));
            }
            
            lucide.createIcons();
        }

        function updateUIAccess() {
            const usersTabBtn = document.getElementById('users-tab-btn');
            if (currentUserRole === 'Admin') {
                usersTabBtn.classList.remove('hidden');
            } else {
                usersTabBtn.classList.add('hidden');
            }
        }
        
        function populateTabContent(tabId) {
            let content = '';
            switch (tabId) {
                case 'dashboard':
                    content = `
                        <h2 class="text-2xl sm:text-3xl font-bold text-gray-800 mb-6">Dashboard</h2>
                        <div class="flex justify-center">
                            <div class="w-full lg:w-2/3 bg-white rounded-xl shadow-lg p-6">
                                <div class="h-96"><canvas id="categoryChart"></canvas></div>
                            </div>
                        </div>`;
                    break;
                case 'products':
                    content = `<div class="flex flex-col sm:flex-row justify-between sm:items-center mb-6 gap-4"><h2 class="text-2xl sm:text-3xl font-bold text-gray-800">Products</h2><button id="add-product-btn" class="bg-brand-accent text-white font-bold py-2 px-4 rounded-lg shadow-md hover:bg-brand-accent-hover transition-colors duration-300 flex items-center justify-center gap-2"><i data-lucide="plus" class="w-5 h-5"></i><span>Add Product</span></button></div><div class="bg-white rounded-xl shadow-lg overflow-x-auto"><table class="w-full responsive-table"><thead><tr class="bg-gray-50"><th class="text-left font-semibold p-4 text-gray-600 uppercase tracking-wider">Name</th><th class="text-left font-semibold p-4 text-gray-600 uppercase tracking-wider">Category</th><th class="text-left font-semibold p-4 text-gray-600 uppercase tracking-wider">Variants</th><th class="text-left font-semibold p-4 text-gray-600 uppercase tracking-wider">Actions</th></tr></thead><tbody id="products-table-body" class="divide-y divide-gray-200"></tbody></table></div>`;
                    break;
                case 'categories':
                    content = `<div class="flex flex-col sm:flex-row justify-between sm:items-center mb-6 gap-4"><h2 class="text-2xl sm:text-3xl font-bold text-gray-800">Categories</h2><button id="add-category-btn" class="bg-brand-accent text-white font-bold py-2 px-4 rounded-lg shadow-md hover:bg-brand-accent-hover flex items-center gap-2"><i data-lucide="plus"></i>Add Category</button></div><div class="bg-white rounded-xl shadow-lg overflow-x-auto"><table class="w-full responsive-table"><thead><tr class="bg-gray-50"><th class="text-left font-semibold p-4 text-gray-600 uppercase tracking-wider">Name</th><th class="text-left font-semibold p-4 text-gray-600 uppercase tracking-wider">Image</th><th class="text-left font-semibold p-4 text-gray-600 uppercase tracking-wider">Actions</th></tr></thead><tbody id="categories-table-body" class="divide-y divide-gray-200"></tbody></table></div>`;
                    break;
                case 'testimonials':
                    content = `<div class="flex flex-col sm:flex-row justify-between sm:items-center mb-6 gap-4"><h2 class="text-2xl sm:text-3xl font-bold text-gray-800">Testimonials</h2><button id="add-testimonial-btn" class="bg-brand-accent text-white font-bold py-2 px-4 rounded-lg shadow-md hover:bg-brand-accent-hover flex items-center gap-2"><i data-lucide="plus"></i>Add Testimonial</button></div><div class="bg-white rounded-xl shadow-lg overflow-x-auto"><table class="w-full responsive-table"><thead><tr class="bg-gray-50"><th class="text-left font-semibold p-4 text-gray-600 uppercase tracking-wider">Name</th><th class="text-left font-semibold p-4 text-gray-600 uppercase tracking-wider">Location</th><th class="text-left font-semibold p-4 text-gray-600 uppercase tracking-wider">Text</th><th class="text-left font-semibold p-4 text-gray-600 uppercase tracking-wider">Actions</th></tr></thead><tbody id="testimonials-table-body" class="divide-y divide-gray-200"></tbody></table></div>`;
                    break;
                case 'site-content':
                    content = `<h2 class="text-2xl sm:text-3xl font-bold text-gray-800 mb-6">Site Content</h2><div class="bg-white rounded-xl shadow-lg p-6 sm:p-8"><form id="site-content-form"><h3 class="text-xl font-semibold mb-4 border-b pb-2">Hero Section</h3><div class="mb-4"><label for="hero-title" class="block text-sm font-medium text-gray-700 mb-1">Title</label><input type="text" name="heroTitle" class="w-full px-3 py-2 border border-gray-300 rounded-md"></div><div class="mb-4"><label for="hero-subtitle" class="block text-sm font-medium text-gray-700 mb-1">Subtitle</label><input type="text" name="heroSubtitle" class="w-full px-3 py-2 border border-gray-300 rounded-md"></div><div class="mb-6"><label for="hero-bg-image" class="block text-sm font-medium text-gray-700 mb-1">Background Image URL</label><input type="url" name="heroBackgroundImage" class="w-full px-3 py-2 border border-gray-300 rounded-md"></div><h3 class="text-xl font-semibold mb-4 mt-8 border-b pb-2">Promotion Bar</h3><div class="mb-6"><label for="promo-text" class="block text-sm font-medium text-gray-700 mb-1">Text</label><input type="text" name="promotionText" class="w-full px-3 py-2 border border-gray-300 rounded-md"></div><div class="flex justify-end"><button type="submit" class="bg-brand-primary text-white font-bold py-2 px-6 rounded-lg hover:bg-gray-800">Save Site Content</button></div></form></div>`;
                    break;
                case 'users':
                    content = `<div class="flex flex-col sm:flex-row justify-between sm:items-center mb-6 gap-4"><h2 class="text-2xl sm:text-3xl font-bold text-gray-800">Users</h2><button id="add-user-btn" class="bg-brand-accent text-white font-bold py-2 px-4 rounded-lg shadow-md hover:bg-brand-accent-hover flex items-center gap-2"><i data-lucide="plus"></i>Add User</button></div><div class="bg-white rounded-xl shadow-lg overflow-x-auto"><table class="w-full responsive-table"><thead><tr class="bg-gray-50"><th class="text-left font-semibold p-4 text-gray-600 uppercase tracking-wider">Email</th><th class="text-left font-semibold p-4 text-gray-600 uppercase tracking-wider">Role</th><th class="text-left font-semibold p-4 text-gray-600 uppercase tracking-wider">Actions</th></tr></thead><tbody id="users-table-body" class="divide-y divide-gray-200"></tbody></table></div>`;
                    break;
            }
            tabContentContainer.innerHTML = content;
            if (tabId === 'site-content') loadSiteContent();
            renderActiveTabData();
            lucide.createIcons();
        }

        function populateModals() {
            document.getElementById('product-modal').innerHTML = `<div class="bg-white rounded-lg shadow-xl p-6 sm:p-8 max-w-2xl w-full max-h-[90vh] overflow-y-auto"><div class="flex justify-between items-center mb-6"><h2 id="product-modal-title" class="text-2xl font-bold">Add New Product</h2><button id="close-product-modal-btn" class="text-gray-500 hover:text-brand-primary"><i data-lucide="x"></i></button></div><form id="product-form" class="space-y-4"><input type="hidden" name="id"><div><label class="block text-sm font-medium">Product Name</label><input type="text" name="name" class="w-full px-3 py-2 border border-gray-300 rounded-md" required></div><div><label class="block text-sm font-medium">Category</label><select id="product-category" name="category" class="w-full px-3 py-2 border border-gray-300 rounded-md" required></select></div><div><label class="block text-sm font-medium">Image URL</label><input type="url" name="image" class="w-full px-3 py-2 border border-gray-300 rounded-md" required></div><div><label class="block text-sm font-medium">Description</label><textarea name="description" rows="3" class="w-full px-3 py-2 border border-gray-300 rounded-md"></textarea></div><div><label class="block text-sm font-medium">Tag (e.g., NEW, SALE)</label><input type="text" name="tag" class="w-full px-3 py-2 border border-gray-300 rounded-md"></div><div><h3 class="text-lg font-semibold mb-2">Variants</h3><div id="variants-container" class="space-y-3"></div><button type="button" id="add-variant-btn" class="mt-2 text-sm text-brand-accent font-semibold hover:underline">+ Add Variant</button></div><div class="mt-4 flex justify-end"><button type="submit" class="bg-brand-primary text-white font-bold py-2 px-6 rounded-lg hover:bg-gray-800">Save Product</button></div></form></div>`;
            document.getElementById('category-modal').innerHTML = `<div class="bg-white rounded-lg shadow-xl p-6 sm:p-8 max-w-lg w-full"><div class="flex justify-between items-center mb-6"><h2 id="category-modal-title" class="text-2xl font-bold">Add New Category</h2><button id="close-category-modal-btn" class="text-gray-500 hover:text-brand-primary"><i data-lucide="x"></i></button></div><form id="category-form" class="space-y-4"><input type="hidden" name="id"><div><label class="block text-sm font-medium">Category Name</label><input type="text" name="name" class="w-full px-3 py-2 border border-gray-300 rounded-md" required></div><div><label class="block text-sm font-medium">Image URL</label><input type="url" name="image" class="w-full px-3 py-2 border border-gray-300 rounded-md" required></div><div class="pt-2 flex justify-end"><button type="submit" class="bg-brand-primary text-white font-bold py-2 px-6 rounded-lg hover:bg-gray-800">Save Category</button></div></form></div>`;
            document.getElementById('testimonial-modal').innerHTML = `<div class="bg-white rounded-lg shadow-xl p-6 sm:p-8 max-w-lg w-full"><div class="flex justify-between items-center mb-6"><h2 id="testimonial-modal-title" class="text-2xl font-bold">Add New Testimonial</h2><button id="close-testimonial-modal-btn" class="text-gray-500 hover:text-brand-primary"><i data-lucide="x"></i></button></div><form id="testimonial-form" class="space-y-4"><input type="hidden" name="id"><div><label class="block text-sm font-medium">Customer Name</label><input type="text" name="name" class="w-full px-3 py-2 border border-gray-300 rounded-md" required></div><div><label class="block text-sm font-medium">Location</label><input type="text" name="location" class="w-full px-3 py-2 border border-gray-300 rounded-md" required></div><div><label class="block text-sm font-medium">Image URL</label><input type="url" name="image" class="w-full px-3 py-2 border border-gray-300 rounded-md" required></div><div><label class="block text-sm font-medium">Testimonial Text</label><textarea name="text" rows="4" class="w-full px-3 py-2 border border-gray-300 rounded-md" required></textarea></div><div class="pt-2 flex justify-end"><button type="submit" class="bg-brand-primary text-white font-bold py-2 px-6 rounded-lg hover:bg-gray-800">Save Testimonial</button></div></form></div>`;
            document.getElementById('user-modal').innerHTML = `<div class="bg-white rounded-lg shadow-xl p-6 sm:p-8 max-w-lg w-full"><div class="flex justify-between items-center mb-6"><h2 id="user-modal-title" class="text-2xl font-bold">Add New User</h2><button id="close-user-modal-btn" class="text-gray-500 hover:text-brand-primary"><i data-lucide="x"></i></button></div><form id="user-form" class="space-y-4"><input type="hidden" name="id"><div><label class="block text-sm font-medium">Email</label><input type="email" name="email" class="w-full px-3 py-2 border border-gray-300 rounded-md" required></div><div class="hidden"><label class="block text-sm font-medium">Password (leave blank if unchanged)</label><input type="password" name="password" class="w-full px-3 py-2 border border-gray-300 rounded-md"></div><div><label class="block text-sm font-medium">Role</label><select name="role" class="w-full px-3 py-2 border border-gray-300 rounded-md" required><option value="Editor">Editor</option><option value="Admin">Admin</option></select></div><div class="pt-2 flex justify-end"><button type="submit" class="bg-brand-primary text-white font-bold py-2 px-6 rounded-lg hover:bg-gray-800">Save User</button></div></form></div>`;
            document.getElementById('confirmation-modal').innerHTML = `<div class="bg-white rounded-lg shadow-xl p-8 max-w-sm w-full"><h2 id="confirmation-title" class="text-xl font-bold mb-4">Are you sure?</h2><p id="confirmation-message" class="text-gray-600 mb-6">You won't be able to revert this!</p><div class="flex justify-end gap-4"><button id="cancel-btn" class="bg-gray-200 text-gray-800 font-bold py-2 px-6 rounded-md hover:bg-gray-300">Cancel</button><button id="confirm-delete-btn" class="bg-red-600 text-white font-bold py-2 px-6 rounded-md hover:bg-red-700">Delete</button></div></div>`;
        }

        function addEventListeners() {
            // Static Listeners
            document.getElementById('login-form').addEventListener('submit', handleLogin);
            document.getElementById('logout-btn').addEventListener('click', handleLogout);
            document.getElementById('open-sidebar-btn').addEventListener('click', () => { sidebar.classList.remove('-translate-x-full'); sidebarOverlay.classList.remove('hidden'); });
            document.getElementById('close-sidebar-btn').addEventListener('click', () => { sidebar.classList.add('-translate-x-full'); sidebarOverlay.classList.add('hidden'); });
            sidebarOverlay.addEventListener('click', () => { sidebar.classList.add('-translate-x-full'); sidebarOverlay.classList.add('hidden'); });
            document.getElementById('sidebar-nav').addEventListener('click', (e) => {
                e.preventDefault();
                const link = e.target.closest('.sidebar-nav-link');
                if (link) switchTab(link.dataset.tab);
            });

            // Event delegation for dynamic content
            tabContentContainer.addEventListener('click', (e) => {
                const target = e.target.closest('button');
                if (!target) return;

                if (target.id === 'add-product-btn') openModal('product-modal', null, 'Product');
                else if (target.id === 'add-category-btn') openModal('category-modal', null, 'Category');
                else if (target.id === 'add-testimonial-btn') openModal('testimonial-modal', null, 'Testimonial');
                else if (target.id === 'add-user-btn') openModal('user-modal', null, 'User');
                
                const { type, id } = target.dataset;
                if (!type || !id) return;

                const collections = { product: products, category: categories, testimonial: testimonials, user: users };
                const item = collections[type]?.find(i => i.id === id);
                
                if (target.classList.contains('edit-btn') && item) {
                    openModal(`${type}-modal`, item, type.charAt(0).toUpperCase() + type.slice(1));
                } else if (target.classList.contains('delete-btn')) {
                    const firestoreCollections = { product: productsCollection, category: categoriesCollection, testimonial: testimonialsCollection, user: usersCollection };
                    showConfirmationModal(id, type, firestoreCollections[type]);
                }
            });
            tabContentContainer.addEventListener('submit', (e) => {
                if (e.target.id === 'site-content-form') handleSiteContentFormSubmit(e);
            });

            // Modal Listeners
            ['product', 'category', 'testimonial', 'user'].forEach(type => {
                const modal = document.getElementById(`${type}-modal`);
                modal.addEventListener('click', (e) => { 
                    if (e.target.closest(`#close-${type}-modal-btn`)) closeModal(`${type}-modal`); 
                    if (e.target.id === 'add-variant-btn') addVariantInput();
                    if (e.target.classList.contains('remove-variant-btn')) e.target.closest('.variant-item').remove();
                });
                modal.addEventListener('submit', (e) => {
                    e.preventDefault();
                    const collections = { Product: productsCollection, Category: categoriesCollection, Testimonial: testimonialsCollection, User: usersCollection };
                    handleFormSubmit(e, type.charAt(0).toUpperCase() + type.slice(1), collections[type.charAt(0).toUpperCase() + type.slice(1)]);
                });
            });

            // Confirmation Modal Listeners
            document.getElementById('confirmation-modal').addEventListener('click', (e) => {
                if(e.target.id === 'cancel-btn') closeConfirmationModal();
                if(e.target.id === 'confirm-delete-btn' && deleteAction) deleteAction();
            });
        }

        // --- App Start ---
        document.addEventListener('DOMContentLoaded', () => {
            populateModals();
            addEventListeners();
            
            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    const userDocRef = doc(db, 'adminUsers', user.uid);
                    try {
                        const userDoc = await getDoc(userDocRef);

                        if (userDoc.exists() && (userDoc.data().role === 'Admin' || userDoc.data().role === 'Editor')) {
                            currentUserRole = userDoc.data().role;
                            document.getElementById('user-email-display').textContent = user.email;
                            document.getElementById('user-role-display').textContent = `Role: ${currentUserRole}`;
                            loginView.classList.add('hidden');
                            adminDashboard.classList.remove('hidden');
                            startDashboardSession();
                        } else {
                            // This case handles users who are authenticated with Firebase Auth
                            // but are not listed in the 'adminUsers' collection or don't have a valid role.
                            console.log("User not authorized.");
                            document.getElementById('login-feedback').textContent = 'You are not authorized to access this panel.';
                            handleLogout();
                        }
                    } catch (error) {
                        console.error("Auth state change error:", error);
                        document.getElementById('login-feedback').textContent = 'An error occurred during authentication.';
                        handleLogout();
                    }
                } else {
                    loginView.classList.remove('hidden');
                    adminDashboard.classList.add('hidden');
                    unsubscribers.forEach(unsub => unsub());
                    unsubscribers = [];
                    currentUserRole = null;
                    document.getElementById('login-form').reset();
                    document.getElementById('login-feedback').textContent = '';
                }
            });
        });

    </script>
</body>
</html>

